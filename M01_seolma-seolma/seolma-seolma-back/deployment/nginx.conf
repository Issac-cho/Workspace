# Nginx 설정 - ALB를 통한 Backend API 연동
# Frontend (Nginx) → ALB → Backend Services

# ALB를 통한 Backend API 연동
upstream backend_api {
    server SM-DEV-Tomcat-ALB-836365371.ap-northeast-2.elb.amazonaws.com:80;
    keepalive 32;
}

# 개발환경용 단일 서버 설정 (기존 호환성)
upstream user_service_dev {
    server 127.0.0.1:8080;
    keepalive 32;
}

upstream product_service_dev {
    server 127.0.0.1:8081;
    keepalive 32;
}

upstream coupon_service_dev {
    server 127.0.0.1:8081;
    keepalive 32;
}

upstream order_service_dev {
    server 127.0.0.1:8083;
    keepalive 32;
}

# 환경별 upstream 선택을 위한 map
map $server_name $use_multi_tier {
    default 0;  # 개발환경 (단일 서버)
    "~*prod" 1; # 운영환경 (3-tier)
    "~*staging" 1; # 스테이징환경 (3-tier)
}

server {
    listen 80;
    server_name _;
    
    # 강제로 ALB 사용 (테스트용)
    set $use_multi_tier 1;
    
    # 로그 설정
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # 기본 설정
    client_max_body_size 10M;
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Health Check (ALB용)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # 공통 프록시 헤더 설정
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    
    # === ALB를 통한 Backend API 라우팅 ===
    
    # 모든 API 요청을 ALB로 프록시
    location /api/ {
        # 디버깅용 로그
        access_log /var/log/nginx/api_debug.log;
        
        if ($use_multi_tier = 1) {
            proxy_pass http://backend_api;
            break;
        }
        
        # 개발환경에서는 기존 로직 유지
        # 쿠폰 API
        if ($uri ~ ^/api/v1/coupons/) {
            proxy_pass http://coupon_service_dev;
            break;
        }
        
        # 상품 API
        if ($uri ~ ^/api/v1/products/) {
            proxy_pass http://product_service_dev;
            break;
        }
        
        # 주문 API
        if ($uri ~ ^/api/v1/orders/) {
            proxy_pass http://order_service_dev;
            break;
        }
        
        # 기본 (사용자 API)
        proxy_pass http://user_service_dev;
    }
    
    # 정적 파일 및 기타 요청 (Frontend)
    location / {
        # Frontend 정적 파일 서빙
        try_files $uri $uri/ /index.html;
        root /var/www/html;
        index index.html;
    }
}

# HTTPS 설정 (운영환경용)
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL 인증서 설정 (Let's Encrypt 또는 AWS Certificate Manager)
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    
    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # HTTP와 동일한 location 설정
    include /etc/nginx/conf.d/common-locations.conf;
}